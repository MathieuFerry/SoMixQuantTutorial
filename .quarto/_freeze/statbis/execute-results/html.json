{
  "hash": "c323285bd138a75cd74c235d8c65f729",
  "result": {
    "engine": "knitr",
    "markdown": "# Bivariate statistics and more graphics\n\nDans ce chapitre, nous abordons maintenant les statistiques bivariées. Nous utilisons toujours la base edu.rds et les mêmes packages que dans le chapitre précédent.\n\n::: {.callout-note title=\"Exercise\"}\n-   Create an empty R script.\n\n-   Save this script in a folder (for instance, \"WinterWorkshop\") and name it for instance \"3Statbis.R\".\n\n-   Load the edu database and run the commands below to install/load packages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# On liste les packages dont on a besoin dans un vecteur nommé load.lib. \nload.lib <- c(\"tidyverse\",\"questionr\",\"Hmisc\",\"esquisse\",\"kableExtra\") \ninstall.lib <- load.lib[!load.lib %in% installed.packages()] # On regarde les paquets qui ne sont pas installés\nfor (lib in install.lib) install.packages(lib,dependencies=TRUE) # On installe ceux-ci\nsapply(load.lib,require,character=TRUE) # Et on charge tous les paquets \n\n\n\nsetwd(\"/home/groups/3genquanti/SoMix/HIES for workshop\")\nedu<-readRDS(\"edu.rds\")\n```\n:::\n\n\n\n:::\n\n## The association between a categorical variable and a numerical variable\n\nIn the chapter on univariate statistics, we discussed several indicators of the distribution of a numerical variable (minimum, maximum, mean, median). Thanks to the lines of code already set up, it is very easy to calculate these statistics for different categories of another categorical variable.\n\nYou simply need to add another function to compute these statistics for each category of a variable, namely `group_by`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |>\n  group_by(province) |>\n  summarise(\n    min    = min(distance, na.rm = TRUE),\n    mean   = wtd.mean(distance,weights=finalweight_25per,na.rm = TRUE),\n    median = wtd.quantile(distance,probs=.5,weights=finalweight_25per,na.rm = TRUE),\n    max    = max(distance, na.rm = TRUE),\n    n_na   = sum(is.na(distance))\n  )\n```\n:::\n\n\n\n\nLet’s study the distance to school according to the place of residence: urban, rural, or estate. This corresponds to the variable sector, with categories 1, 2, and 3. We can recode these categories using the icut() interface, or directly with the following code:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu$sector_rec <- edu$sector  |>\n  as.character() |>\n  fct_recode(\n    \"Urban\" = \"1\",\n    \"Rural\" = \"2\",\n    \"Estate\" = \"3\"\n  )\n\nedu |>\n  group_by(sector_rec) |>\n  summarise(\n    min    = min(distance, na.rm = TRUE),\n    mean   = wtd.mean(distance,weights=finalweight_25per,na.rm = TRUE),\n    median = wtd.quantile(distance,probs=.5,weights=finalweight_25per,na.rm = TRUE),\n    max    = max(distance, na.rm = TRUE),\n    n_na   = sum(is.na(distance))\n  )\n```\n:::\n\n\n\n\nWe can readily analyse how the distance to school varies across multiple categorical variables. For example, we can compute the mean and the median with respect to both the province and the place of residence:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |>\n  group_by(province,sector_rec) |>\n  summarise(\n    mean   = wtd.mean(distance,weights=finalweight_25per,na.rm = TRUE),\n    median = wtd.quantile(distance,probs=.5,weights=finalweight_25per,na.rm = TRUE)\n  ) |> \n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Urban-rural gap in distance to school by province](images/Capture%20d’écran%202025-11-21%20à%2021.58.25.png){fig-align=\"center\"}\n\nThe distance to school tends to be higher in rural areas, and this difference is mainly driven by extreme values. Indeed, it is primarily the mean, which is more sensitive to large values, that reflects this gap, more so than the median.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |>\n  group_by(province,sector_rec) |>\n  summarise(\n    mean   = wtd.mean(distance,weights=finalweight_25per,na.rm = TRUE) \n  ) |> \n  pivot_wider(names_from=sector_rec,values_from=mean) |>\n  mutate(`Urban-Rural difference`=Urban-Rural) |>\n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Urban-rural gap in distance to school by province](images/Capture%20d’écran%202025-11-21%20à%2021.57.52.png){fig-align=\"center\"}\n\nWe can clearly see from this last analysis that this pattern holds in all provinces (except North Western), but the gap varies: it is higher in the Sabaragamuwa and Southern provinces, where the distance to school for children in estate areas is particularly pronounced.\n\n### Summarizing with the mean and the standard deviation\n\nIt is quite common in academic articles to describe quantitative variables by reporting the mean (a measure of central tendency) and the standard deviation (a measure of dispersion, equal to the square root of the variance).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |>\n  group_by(sector_rec) |>\n  summarise(\n    mean= mean(distance,na.rm=T),\n    sd= sd(distance,na.rm=T),\n  ) |>\n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Mean and standard deviation of distance to school by residence](images/Capture%20d’écran%202025-11-21%20à%2022.06.22.png){fig-align=\"center\"}\n\nWhy are these two indicators used? First, we can say from this table that, on average, the distance to school is higher for children in rural areas than in urban areas. There is also greater variability in the distance to school in rural areas (sd stands for standard deviation).\n\n::: callout-tip\nShould we summarize a variable by its mean or its median?\n\nThe first option is very common (especially in English-language journals) but is not necessarily the most appropriate…\n\nWhen working with skewed (i.e., non-normal) distributions:\n\n-   The mean is sensitive to extreme values in the distribution.\n\n-   It may be best to have a look at both and plot the distributions!\n\nNote: in fact, the standard deviation is then also not really a reliable indicator of dispersion describing the distribution. One may then prefer to calculate quantiles (e.g. quartiles, following Tukey's 5 number summary!).\n:::\n\n::: {.callout-note title=\"Exercise\" icon=\"false\"}\nUsing esquisser, reproduce the following plot. Try to improve it by playing with color palettes, font sizes...\n\nWhat is your take away from this plot and from the previous statistics?\n\n![Density of the distance to school by residence location](images/esquisse-plot.png){fig-align=\"center\"}\n:::\n\n## The association between two categorical variables and the cross-tabulation\n\n### Some conventions for cross-tabulations\n\nWe now come to cross-tabulations to study the associations between two categorical variables.\n\nFirst, let's recall a few analysis conventions. It’s easy to get confused when creating cross-tabulations, so keep the following points in mind:\n\n-   What is my *response variable* or *dependent variable*, i.e., the variable assumed to depend on another factor?\n\n-   What is my *independent variable*, i.e., the variable assumed to have an effect on the dependent variable?\n\nOn peut par exemple ici supposer que le fait d'être actuellement scolarisé (variable r2_school_education) dépend du niveau de diplôme des parents, mais aussi de leur niveau économique, du lieu de résidence, etc.\n\n-   To visualize whether a factor affects a dependent variable, we can create a cross-tabulation in which:\n\n-   The dependent variable is placed in the columns.\n\n-   The independent variable is placed in the rows.\n\n-   Row percentages are calculated (we need to normalize the row counts to compare them!).\n\n-   We then compare the rows within the same column.\n\nOf course, this is theory.\n\nThere are many cases where we might be more interested in column percentages, or even total percentages, or we may want to swap rows and columns. Nevertheless, keeping these simple conventions in mind helps to stay oriented when navigating statistical analyses.\n\n### Practical application of the cross-tabulation\n\nWe again use the functions from the `questionr` package. To create a cross-tabulation of unweighted counts, we can write:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu$r2_school_education_rec <- edu$r2_school_education  |>\n  as.character() |>\n  fct_recode(\n    \"Currently attending\" = \"1\",\n    \"Never attended\" = \"2\",\n    \"Attended school in the past\" = \"3\"\n  )\n\nedu |> freqtable(sector_rec,r2_school_education_rec) |>\n  kbl() |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Frequency cross-tabulation](images/Capture%20d’écran%202025-11-22%20à%2013.47.19.png){fig-align=\"center\"}\n\nThe row variable (here `edu_parents`) is the independent variable — it is written first — while the column variable (here `r2_school_education_rec`) is the dependent variable.\n\nThe table of counts is useful because it shows that some cells contain relatively small numbers of observations, which should make us cautious when interpreting the corresponding rows/columns.\n\nTo obtain total percentages (joint percentages):\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |> freqtable(sector_rec,r2_school_education_rec,weights=finalweight_25per) |>\n  prop() |>\n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Joint percentages](images/Capture%20d’écran%202025-11-22%20à%2013.47.40.png){fig-align=\"center\"}\n\nFrom this table, we can say that the most frequent combination of residential location and children’s schooling status is children living in rural areas who are currently enrolled in school (68% of all children).\n\nWe can also compute column percentages:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |> freqtable(sector_rec,r2_school_education_rec,weights=finalweight_25per) |>\n  cprop() |>\n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Column percentages](images/Capture%20d’écran%202025-11-22%20à%2014.02.38.png){fig-align=\"center\"}\n\nHere, we see that among children who are currently in school, 79% live in rural areas (and 79% of all children, regardless of schooling status, live in rural areas).\n\nAmong children who have never attended school, 83% live in rural areas. Children from rural areas are therefore slightly over-represented among those who have never attended school.\n\nConversely, they are slightly under-represented among children who are not currently enrolled but have been enrolled in the past (78%).\n\nFinally, row percentages make interpretation easier when assessing whether there is an association between residential location and schooling:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |> freqtable(sector_rec,r2_school_education_rec,weights=finalweight_25per) |>\n  lprop() |>\n  kbl(digits=1) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![Row percentages](images/Capture%20d’écran%202025-11-22%20à%2013.53.54.png){fig-align=\"center\"}\n\nHere, we clearly see that, regardless of residential location, the most frequent situation for children is to be currently enrolled in school.\n\nOnly 3% of children have never attended school, and this configuration is slightly less common in urban areas and estates. In other words, never having attended school — a very marginal situation overall — is mainly a rural phenomenon.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSalaires |> freqtable(race,salaire_quint) |> prop(n=T,digit=0)\n```\n:::\n\n\n\n\n::: {.callout-note title=\"Exercise\" icon=\"false\"}\nStudy the association between age and school attendance with a row percentage cross tabulation.\n:::\n\n### From the table to the graphic\n\nEsquisse can again in these cases be used to build represent graphically the association between residence and school attendance. Here, our category of interest is specifically \"never attending school\".\n\nYou first need to store the row-percentage tabulation (transformed as a \"data.frame\" using the `as.data.frame()` function) in an object (rtab), then open esquisser with this specific command.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrtab<-edu |> freqtable(sector_rec,r2_school_education_rec,weights=finalweight_25per) |>\n  lprop() |> as.data.frame() \nesquisser(rtab)\n```\n:::\n\n\n\n\nYou can then drop the residence variable on the X-axis tab and Freq in the Y-axis tab. Using the \"Data\" section at the bottom, remove all the categories of the `r2_school_education_rec` variable, except \"Never attending school\". You can further refine the graphic by increasing the font, changing the axis labels, adding a title...\n\n![Never attending school children](images/Capture%20d’écran%202025-11-22%20à%2014.15.48.png)\n\n### Cross-tabulation with three variables?\n\nVery often, we study social processes that depend on multiple social factors. For instance, school attendance may vary according to age (see above exercise), but age may impact differently school attendance for male and female children.\n\nOne first easy solution to study this is simply to filter the row percentage cross tabulations according to the different categories of a third variable (here, sex).\n\nFor instance:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nedu |> \n  filter(sex==\"Male\") |>\n  freqtable(age,r2_school_education_rec,weights=finalweight_25per) |>\n  lprop() |>\n  kbl(digits=0) |> kable_classic(full_width = F)\nedu |> \n  filter(sex==\"Female\") |>\n  freqtable(age,r2_school_education_rec,weights=finalweight_25per) |>\n  lprop() |>\n  kbl(digits=0) |> kable_classic(full_width = F)\n```\n:::\n\n\n\n\n![School attendance by age for male children](images/Capture%20d’écran%202025-11-22%20à%2015.46.58.png) ![School attendance by age for female children](images/Capture%20d’écran%202025-11-22%20à%2015.47.07.png)\n\nThis code prints successively two crosstabs in the Viewer panel, but it is not ideal as we would want to see them on the same page.\n\nWe can actually simply write:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab3<-edu |> \n  freqtable(age,r2_school_education_rec,sex,weights=finalweight_25per) |>\n  lprop() \ntab3\n```\n:::\n\n\n\n\n`tab3` contains the three-way cross tabulation. We have simply added the sex variable after the dependent within the `freqtable()` function.\n\nUnfortunately, viewing this bigger table in the Viewer panel is not so straightforward with the existing `kableExtra` functions. One solution is to create our own function that we will be able to use at any time whenever we want to study a 3-way cross tabulation.\n\nRun the following code which will create the `kbl_grouped_3way()` function:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbl_grouped_3way <- function(tab,digits=1) {\n  # Convert to data frame (Sex / Age / Category / Freq etc.)\n  df <- as.data.frame(tab)\n  # Identify names of the three dimensions\n  dims <- names(df)[names(df) != \"Freq\"]\n  # For readability\n  dim1 <- dims[1]   # row dimension (ex: age)\n  dim2 <- dims[2]   # column dimension (ex: school status)\n  dim3 <- dims[3]   # grouping dimension (ex: sex)\n  # Convert to wide\n  df_wide <- df |>\n    tidyr::pivot_wider(\n      names_from = all_of(dim2), \n      values_from = Freq\n    )\n  # Keep a copy of grouping variable and row order before dropping\n  grouping_var <- df_wide[[dim3]]\n  # Build table\n  tab_out <- df_wide |>\n    select(-all_of(dim3)) |>\n    kbl(digits = digits) \n  # How many rows per group?\n  group_levels <- unique(grouping_var)\n  groups <- split(seq_len(nrow(df_wide)), grouping_var)\n  # Add pack_rows dynamically\n  for (g in group_levels) {\n    rows <- groups[[g]]\n    tab_out <- tab_out |>\n      pack_rows(group = g,\n                start_row = min(rows),\n                end_row = max(rows))\n  }\n  tab_out\n}\n```\n:::\n\n\n\n\nThen, just apply to the tab3 object:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkbl_grouped_3way(m,digits=0) |>\n    kable_classic_2(full_width = FALSE)\n```\n:::\n\n\n\n\n![School attendance by age and sex](images/Capture%20d’écran%202025-11-22%20à%2015.46.24.png)\n\nOf course, it is also possible to produce a figure, which could for instance look like this:\n\n![Graphic of the school attendance by age and sex](images/Capture%20d’écran%202025-11-22%20à%2015.52.33.png)\n\n::: {.callout-note title=\"Exercise\" icon=\"false\"}\nStudy how the association between age and school attendance vary by residence locality (urban, rural and estate).\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}